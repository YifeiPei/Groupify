<script>

$(document).ready(function() {
  var par = $('table');
  $(par).hide();
  $("#deleteStudentMsg").hide();
  $("#successdeleteStudentMsg").hide();
  function amountOfStudents() {
    $("table").each(function() {
      var amount = $($(this).children("tbody")[0]).children('tr').length;
      var groupCount = $(this).siblings(".groupcount")[0];
      var groupAmount = $(groupCount).children(".groupcountnumber")[0];
      $(groupAmount).html(amount);
    });
  }
  $("table").sortable({
    items: 'tbody > tr',
    cursor: 'move',
    connectWith: 'table',
    dropOnEmpty: true,
    receive: function(e, ui){

      // only append to tbody if the row body is empty
      if ($(this).find("tbody").children("tr").length == 0) {
        $(this).find("tbody").append(ui.item);
      }
      amountOfStudents(ui);
      $.post('/grouped/drop_update', {student_id: ui.item.attr("id"), group_id: $(this).find("tbody").attr("id")});
    }
  });
});
function deleteStudent(){
  	$("#deleteStudentMsg").show();
	$("tbody").css('cursor', 'move');
 	$("tbody").click(function(e, ui){
	    yesnodialog('Comfirm', 'Cancel', $(this), $(this).find("tr").attr("id"));
	});

};
function yesnodialog(button1, button2, element, id){
  var btns = {};
  btns[button1] = function(){ 
      element.parents('li').hide();
      $(this).dialog("close");
  	  $.post('/grouped/delete_student', {student_id: id});
   	 alert("The student has been successfuly deleted.");
  	  location.reload();

  };
  btns[button2] = function(){ 
      // Do nothing
      $(this).dialog("close");
  };
  $("<div>Are you sure?</div>").dialog({
    autoOpen: true,
    title: 'Comfirm',
    modal:true,
    buttons:btns
  });
}
$('.delete').click(function(){
    yesnodialog('Yes', 'No', $(this));
})

function showGroup(msg) {
    $('#' + msg).toggle(500);
};
$("h3").css('cursor', 'pointer');
$("tbody").css('cursor', 'move');
function hideAll() {
  var par = $('table');
  $(par).hide();
  };
function showAll() {
  var par = $('table');
  $(par).show();};
</script>

<div class="container">

<h1><%= @current_course.name %></h1>
  	
	<div id="deleteStudentMsg" class="alert alert-info" >
      <a href="#" class="close" data-dismiss="alert">&times;</a>
      You can click on a student to delete him
  	</div>
<% if !@current_course.confirmed %>
  <%= form_tag '/sort/save_config', {"style"=>"display: inline-block"} do %>
    <%= label_tag :group_size, "Group Size" %>
    <%= number_field_tag 'group_size', @old_size, in: 1...10 %>
    <br />
    <%= submit_tag 'Resort', class: "btn" %>
    <%= link_to "<button class= 'btn'>Confirm Groups</button>".html_safe, {controller: "contact", action: "notify_group" , id: @current_course.id}, {data:{confirm: "Do you want to finalise the groups for #{@current_course.name}?"}} %>
  <% end %>
<% else %>
  <div class="alert alert-info">
      <a href="#" class="close" data-dismiss="alert">&times;</a>
      These are the groups that has been confimed for your course
  </div>
<% end %>
 <%= button_to("Add student", '/grouped', {class: "btn", remote: true, form: {"style" => "display: inline-block", id: "add_student_button"}}) %>
  <%= button_tag('Delete student', {class: 'btn', onclick: "deleteStudent();", type: 'button'}) %>
 <%= button_tag('Download', {class: 'btn', onclick: "window.location.href='/grouped/export_csv'", type: 'button'}) %>
 <%= button_tag('Back', {class: 'btn', onclick: "window.location.href='/lecturer'", type: 'button'}) %>
  <div id="add_student" class="row">
  <% if !session[:err_msg][1].blank? && !session[:err_msg][2].blank? && !session[:err_msg][3].blank?  %>

    <% for i in 1..3 %>
      <% if !session[:err_msg][i].blank?  %>
        <div class="alert alert-warning">
          <a href="#" class="close" data-dismiss="alert">&times;</a>
          <%= session[:err_msg][i] %>
        </div>
      <% end %>
    <% end %>
    <%= render partial: "form" %>
      <% end %>
	</div>	
  <%= button_tag('Show All', {class: 'btn', onclick: "showAll();", type: 'button'}) %>
 <%= button_tag('Hide All', {class: 'btn', onclick: "hideAll();", type: 'button'}) %>


<% for i in 1..@group_count %>
  <% @students = Student.find(:all, :conditions => {:course_id => @current_course.id, :group_id => Group.find_by(:course_id => @current_course.id, :number => i).id}) %>

  <% if i%2 == 1 %>
      <div class="row">
  <% end%>

  <div class="col-md-6">
    <h3 onclick="showGroup(<%= i %>);" style="cursor: pointer; display: inline-block">Group <%= i %></h3>
    <div class="groupcount">(<span class="groupcountnumber"><%= @students.count %></span> students)</div>
    <table class="table" id = "<%= i %>">
    <thead>
      <tr>
        <th>Student Number</th>
         <th>Name</th>
        <th>Degree</th>
      </tr>
    </thead>
    <tbody id = "<%= Group.find_by(:course_id => @current_course.id, :number => i).id %>" style="cursor: move">

      <% @students.each do |student| %>
        <tr id = "<%= student.id %>" class = "confirm">
          <td><%= student.student_id %></td>
          <td><%= student.first_name %> <%= student.last_name %></td>
          <td><%= student.degree %></td>
        </tr>
      <% end %>
    </tbody>
    </table>
  </div>
  
  <% if i%2 == 0 %>
    </div>
  <% end%>
<% end %>

<% if @group_count%2 == 1 %>
  </div>
<% end %>
</div>