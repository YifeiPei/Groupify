<script>
$(document).ready(function() {
  var par = $('table');
  $(par).hide();
  });
$(function() {
  $("table").sortable({
    items: 'tbody > tr',
    cursor: 'move',
    connectWith: 'table',
    dropOnEmpty: true,
    receive: function(e, ui){
      $(this).find("tbody").append(ui.item);
	  $.post('/grouped/drop_update', {student_id: ui.item.attr("id"), group_id: $(this).find("tbody").attr("id")});
	}
  });
});
function showGroup(msg) {
    $('#' + msg).toggle(500);
};
$("h3").css('cursor', 'pointer');
$("tbody").css('cursor', 'move');
function hideAll() {
  var par = $('table');
  $(par).hide();
  };
function showAll() {
  var par = $('table');
  $(par).show();};

</script>
<div class="container">

<h1><%= @current_course.name %></h1>

<% if !@current_course.confirmed %>
  <%= form_tag '/sort/save_config', {"style"=>"display: inline-block"} do %>
    <%= label_tag :group_size, "Group Size" %>
    <%= number_field_tag 'group_size', @old_size, in: 1...10 %>
    <br />
    <%= submit_tag 'Resort', class: "btn" %>
    <%= link_to "<button class= 'btn'>Confirm Groups</button>".html_safe, {controller: "contact", action: "notify_group" , id: @current_course.id}, {data:{confirm: "Do you want to finalise the groups for #{@current_course.name}?"}} %>
  <% end %>
<% else %>
  <div class="alert alert-info">
      <a href="#" class="close" data-dismiss="alert">&times;</a>
      These are the groups that has been confimed for your course
  </div>
<% end %>
 <%= button_tag('Download', {class: 'btn', onclick: "window.location.href='/grouped/export_csv'", type: 'button'}) %>
  <%= button_tag('Show All', {class: 'btn', onclick: "showAll();", type: 'button'}) %>
  <% if session[:err_msg][1].blank? && session[:err_msg][2].blank? && session[:err_msg][3].blank?  %>
 	<div id="add_student">
    <%= button_to("Add student", '/grouped', {class: "btn", id: "add_student", remote: true}) %>
	</div>	
    <% else %>
   	 <% for i in 1..3 %>
  		<% if !session[:err_msg][i].blank?  %>
	   		<div class="alert alert-warning">
      		<a href="#" class="close" data-dismiss="alert">&times;</a>
      		<%= session[:err_msg][i] %>
  			</div>
  		<% end %>
   	<% end %>
    <%= render partial: "form" %>
  		<% end %>
 <%= button_tag('Hide All', {class: 'btn', onclick: "hideAll();", type: 'button'}) %>
 <%= button_tag('Back', {class: 'btn', onclick: "window.location.href='/lecturer'", type: 'button'}) %>


<% for i in 1..@group_count %>
  <% if i%2 == 1 %>
      <div class="row">
  <% end%>

  <div class="col-md-6">
    <h3 onclick="showGroup(<%= i %>);" style="cursor: pointer">Group <%= i %></h3>
   <table class="table" id = "<%= i %>">
    <thead>
      <tr>
        <th>Student Number</th>
         <th>Name</th>
        <th>Degree</th>
      </tr>
    </thead>
    <tbody id = "<%= Group.find_by(:course_id => @current_course.id, :number => i).id %>" style="cursor: move">

    <% @students = Student.find(:all, :conditions => {:course_id => @current_course.id, :group_id => Group.find_by(:course_id => @current_course.id, :number => i).id}) %>
      <% @students.each do |student| %>
        <tr id = "<%= student.id %>" >
          <td><%= student.student_id %></td>
          <td><%= student.first_name %> <%= student.last_name %></td>
          <td><%= student.degree %></td>
        </tr>
      <% end %>
    </tbody>
    </table>
  </div>
  
  <% if i%2 == 0 %>
    </div>
  <% end%>
<% end %>

<% if @group_count%2 == 1 %>
  </div>
<% end %>
</div>